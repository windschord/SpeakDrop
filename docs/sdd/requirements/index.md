# 要件定義: SpeakDrop

## 概要

macOS上で動作する、完全ローカルの音声入力アプリケーション。メニューバーに常駐し、プッシュトーク方式でどのアプリケーションからでも音声入力が可能。faster-whisper（Kotoba Whisper V1.0）による高精度な日本語音声認識と、Ollama LLMによるテキスト後処理（句読点挿入・話し言葉整形）を組み合わせ、認識結果をクリップボード経由で任意のアプリに挿入する。

### 技術スタック

| 役割 | 技術 |
|------|------|
| 言語 | Python 3.11+ |
| メニューバーUI | rumps |
| グローバルホットキー | pynput |
| 音声録音 | sounddevice |
| 音声認識 | faster-whisper（CTranslate2ベース） |
| 日本語モデル | kotoba-tech/kotoba-whisper-v1.0 |
| テキスト後処理 | Ollama（qwen2.5:7b推奨） |
| テキスト挿入 | pyobjc（NSPasteboard + CGEvent Cmd+V） |
| パッケージ管理 | uv |
| コード品質 | ruff + mypy + pytest |

---

## ユーザーストーリー一覧

| ID | タイトル | 優先度 | ステータス | 詳細リンク |
|----|---------|--------|-----------|------------|
| US-001 | プッシュトークによる音声入力 | 高 | 承認済 | [詳細](stories/US-001.md) @stories/US-001.md |
| US-002 | テキスト後処理（句読点挿入・整形） | 高 | 承認済 | [詳細](stories/US-002.md) @stories/US-002.md |
| US-003 | メニューバー常駐と設定 | 高 | 承認済 | [詳細](stories/US-003.md) @stories/US-003.md |
| US-004 | ホットキーの設定 | 中 | 承認済 | [詳細](stories/US-004.md) @stories/US-004.md |
| US-005 | 音声認識モデルの設定 | 中 | 承認済 | [詳細](stories/US-005.md) @stories/US-005.md |
| US-006 | macOS権限の管理 | 高 | 承認済 | [詳細](stories/US-006.md) @stories/US-006.md |

---

## 機能要件サマリ

| 要件ID | 概要 | 関連ストーリー | ステータス |
|--------|------|---------------|-----------|
| REQ-001 | プッシュトークキー押下時に録音開始 | US-001 | 定義済 |
| REQ-002 | プッシュトークキー離放時に録音停止・認識開始 | US-001 | 定義済 |
| REQ-003 | 録音中はメニューバーアイコンを録音中状態に変更 | US-001 | 定義済 |
| REQ-004 | 処理中はメニューバーアイコンを処理中状態に変更 | US-001 | 定義済 |
| REQ-005 | 認識完了時にテキストをクリップボード経由で挿入 | US-001 | 定義済 |
| REQ-006 | テキスト挿入前後にクリップボード内容を退避・復元 | US-001 | 定義済 |
| REQ-007 | Ollama LLMで句読点（。、！？）を挿入 | US-002 | 定義済 |
| REQ-008 | Ollama LLMで話し言葉を書き言葉に整形 | US-002 | 定義済 |
| REQ-009 | Ollama未起動時は後処理をスキップして生テキスト挿入 | US-002 | 定義済 |
| REQ-010 | システム起動時にメニューバーにアイコンを表示 | US-003 | 定義済 |
| REQ-011 | メニューバーアイコンクリックでドロップダウンを表示 | US-003 | 定義済 |
| REQ-012 | ドロップダウンに状態表示・ON/OFF切替・設定・終了を含める | US-003 | 定義済 |
| REQ-013 | 設定メニュー選択時に設定ダイアログを表示 | US-003 | 定義済 |
| REQ-014 | 設定画面でプッシュトークキーの変更機能を提供 | US-004 | 定義済 |
| REQ-015 | ホットキー変更ボタン押下後に次のキーをキャプチャして登録 | US-004 | 定義済 |
| REQ-016 | 設定変更時にJSONファイルへ永続化 | US-004 | 定義済 |
| REQ-017 | 起動時に設定ファイルが存在すれば読み込む | US-004 | 定義済 |
| REQ-018 | 設定画面で音声認識モデルをリストから選択できる | US-005 | 定義済 |
| REQ-019 | モデル変更時にモデルを再読み込み | US-005 | 定義済 |
| REQ-020 | モデル未キャッシュ時にダウンロード進捗を通知で表示 | US-005 | 定義済 |
| REQ-021 | 起動時にマイク権限未付与の場合、権限要求ダイアログを表示 | US-006 | 定義済 |
| REQ-022 | 起動時にアクセシビリティ権限未付与の場合、設定画面への案内を表示 | US-006 | 定義済 |

---

## 非機能要件一覧

| カテゴリ | 詳細リンク | 要件数 |
|----------|------------|--------|
| 性能要件 | [詳細](nfr/performance.md) @nfr/performance.md | 4件 |
| セキュリティ・プライバシー要件 | [詳細](nfr/security.md) @nfr/security.md | 2件 |
| ユーザビリティ要件 | [詳細](nfr/usability.md) @nfr/usability.md | 2件 |
| 保守性要件 | [詳細](nfr/maintainability.md) @nfr/maintainability.md | 2件 |

### 非機能要件サマリ

| 要件ID | 概要 | カテゴリ | ステータス |
|--------|------|----------|-----------|
| NFR-001 | 10秒音声に対し5秒以内の音声認識処理完了 | 性能 | 定義済 |
| NFR-002 | 200文字テキストに対し3秒以内のLLM後処理完了 | 性能 | 定義済 |
| NFR-003 | 待機時メモリ使用量500MB以下 | 性能 | 定義済 |
| NFR-004 | 音声録音フォーマット: 16kHz/Mono/16bit PCM | 性能 | 定義済 |
| NFR-005 | すべての音声・テキストデータをローカルのみで処理 | セキュリティ | 定義済 |
| NFR-006 | 録音音声データは認識完了後にメモリから破棄 | セキュリティ | 定義済 |
| NFR-007 | メニューバーアイコン状態変化を200ms以内に反映 | ユーザビリティ | 定義済 |
| NFR-008 | macOS 13以降のApple Silicon Macで動作 | ユーザビリティ | 定義済 |
| NFR-009 | ruff + mypyによるコード品質基準をすべてパス | 保守性 | 定義済 |
| NFR-010 | 主要モジュールのテストカバレッジ80%以上を維持 | 保守性 | 定義済 |

---

## 依存関係

### 外部ソフトウェア

| ソフトウェア | 用途 | 必要条件 |
|------------|------|---------|
| Python 3.11以上 | アプリ実行環境 | 必須 |
| Ollama | テキスト後処理 | 事前インストール・起動が必要（任意） |
| qwen2.5:7b | Ollamaモデル | `ollama pull qwen2.5:7b` で事前取得 |

### macOSシステム権限

| 権限 | 用途 |
|------|------|
| マイクアクセス権限 | 音声録音に必要 |
| アクセシビリティ権限 | グローバルキーイベント監視・テキスト挿入に必要 |

### Pythonパッケージ

| パッケージ | 用途 |
|-----------|------|
| rumps | メニューバーUI |
| pynput | グローバルホットキー監視 |
| sounddevice | マイク録音 |
| faster-whisper | 音声認識エンジン |
| numpy | 音声データ処理 |
| ollama | Ollama Pythonクライアント |
| pyobjc-framework-Cocoa | クリップボード操作（NSPasteboard） |
| pyobjc-framework-Quartz | キーストローク送信（CGEvent） |

---

## スコープ外

以下の機能は本バージョンの対象外とする:

- リアルタイムストリーミング認識（本バージョンではプッシュトーク単位のバッチ認識）
- 話者分離（diarization）
- 議事録自動生成（Ollama RAG機能）
- 英語など日本語以外の言語への対応（将来拡張として検討）
- ログイン時の自動起動設定（将来拡張として検討）
- App Store配布・コード署名
- Web UI / Electron UI
- 音声ファイルの永続保存・再生機能

---

## ドキュメント構成

```
docs/sdd/requirements/
├── index.md                        # このファイル（目次）
├── stories/
│   ├── US-001.md                   # プッシュトークによる音声入力
│   ├── US-002.md                   # テキスト後処理
│   ├── US-003.md                   # メニューバー常駐と設定
│   ├── US-004.md                   # ホットキーの設定
│   ├── US-005.md                   # 音声認識モデルの設定
│   └── US-006.md                   # macOS権限の管理
└── nfr/
    ├── performance.md              # 性能要件
    ├── security.md                 # セキュリティ・プライバシー要件
    ├── usability.md                # ユーザビリティ要件
    └── maintainability.md          # 保守性要件
```
